/* stylelint-disable scss/dollar-variable-pattern */
/* stylelint-disable scss/function-no-unknown */
@use "sass:map";
@use "sass:meta";
@use './globals.scss' as globals;
@use './levels.scss' as levels;
@use './rules.scss' as rules;
@use './helpers.scss' as helpers;
@use './test-helpers.scss' as testHelpers;
@use './process.scss' as process;
@use './output.scss' as output;
@use './selectors.scss' as selectors;

@function init-controlled-bem($args...) {
  $argMap: helpers.arg-list-to-map($args...);
  $rootSelector: null;
  $parent: &;
  $rules: rules.rules-to-map($argMap);
  $levels: [];
  $blockName: map.get($argMap, 'block');
  $configInArgs: map.get($argMap, 'config') or helpers.create-empty-map();
  $config: map.merge(
    (
      'blockName': $blockName,
      'rootSelector': $rootSelector,
      'parent': $parent,
      'blockPrefix': globals.$BLOCK-PREFIX,
      'modifierDelimeter': globals.$MODIFIER-DELIMETER,
      'elementDelimeter': globals.$ELEMENT-DELIMETER,
    ),
    $configInArgs
  );

  @return globals.init-global-bem($rules, $levels, $config);
}

/// for future use with nested init-controlled-bem() calls
@function end-controlled-bem() {
  @return null;
}

@mixin start-emit-end($args...) {
  $createdLevel: process.start($args...);

  @include output.emit($createdLevel) {
    @content;
  }

  $void: process.end();
}

@mixin block() {
  $createdLevel: process.start(
    $block: '',
  );

  @include output.emit($createdLevel) {
    @content;
  }

  $void: process.end();
}

@mixin content($element: '') {
  $createdLevel: process.start(
    $content: $element,
  );

  @include output.emit($createdLevel) {
    @content;
  }

  $void: process.end();
}

@mixin modifier($modifier) {
  $createdLevel: process.start(
    $modifier: $modifier,
  );

  @include output.emit($createdLevel) {
    @content;
  }

  $void: process.end();
}

@mixin element($element) {
  $createdLevel: process.start(
    $element: $element,
  );

  @include output.emit($createdLevel) {
    @content;
  }

  $void: process.end();
}

@mixin extra($extra) {
  $createdLevel: process.start(
    $extra: $extra,
  );

  @include output.emit($createdLevel) {
    @content;
  }

  $void: process.end();
}

@mixin custom($selector) {
  $createdLevel: process.start(
    $custom: $selector,
  );

  @include output.emit($createdLevel) {
    @content;
  }

  $void: process.end();
}

// SPECIAL CASES / HELPERS

@mixin if-block-content-allowed() {
  $isBaseContentAllowed: rules.is-base-content-allowed(global.get-global-bem-rules());

  @if $isBaseContentAllowed {
    @content;
  }
}

@mixin selector-list($list) {
  $selector: '';
  $config: globals.get-global-bem-config();

  @each $item in $list {
    $tempLevel: process.create-process-level(
      $ARGS_MAP: $item,
    );
    $keyAndValue: helpers.get-map-data-with-value($item);
    $type: map.get($keyAndValue, 'key');
    $name: map.get($keyAndValue, 'value');

    /// $levelSelector: selectors.create-selector(&, $type, $name, $config);

    $levelSelector: levels.get-level-selector($tempLevel);

    /// debug '$levelSelector: #{$levelSelector}';

    @if $levelSelector {
      @if $selector != '' {
        $selector: '#{$selector},&#{$levelSelector}';
      } @else {
        $selector: '&#{$levelSelector}';
      }
    }
  }

  $newLevel: process.create-process-level(
    $custom: '> .will-be-overridden',
  );
  $newLevel: levels.set-level-selector($newLevel, $selector);

  // children of this entity should emit nested css
  $newLevel: levels.set-level-emit-target-to-nested($newLevel);

  /// $newLevel: levels.set-level-emit-target-to-parent-selector($newLevel);
  $void: globals.add-global-bem-level($newLevel);

  @include output.emit($newLevel) {
    @content;
  }

  $void: process.end();
}

/// https://sass-lang.com/documentation/modules/selector/#nest
@mixin nest() {
  $newLevel: process.create-process-level(
    $directive: 'nest',
  );
  $newLevel: levels.set-level-emit-target-to-nested($newLevel);
  $void: globals.add-global-bem-level($newLevel);

  @include output.emit($newLevel) {
    @content;
  }

  $void: process.end();
}

// gets nearest entity by type and name (if given) and appends to its selector with given separator
// the level to append is given as $typeAndName ($type:'modifier', name:null/true/string)
// the entity is given as $block, $modifier, etc.
@mixin linked-entities($typeAndName, $separator, $args...) {
  $currentLevel: process.get-current-level();
  $currentLevelSelector: levels.get-level-selector($currentLevel);
  $closest: levels.find-closest-in-current($args...);
  $type: map.get($typeAndName, 'type');
  $name: map.get($typeAndName, 'name');

  @if $closest and $type {
    ///$closestSelector: levels.get-level-selector($closest);
    $closestSelector: levels.collect-parent-entity-selectors($closest);
    $ARGS_MAP: helpers.create-empty-map();
    $ARGS_MAP: map.set($ARGS_MAP, $type, $name);
    $newLevel: process.create-process-level(
      $ARGS_MAP: $ARGS_MAP,
    );
    $selector: selectors.create-selector($closestSelector, $type, $name, globals.get-global-bem-config());
    $prefix: if($separator == '', '&', '');
    $newLevel: levels.set-level-selector($newLevel, '#{$prefix}#{$closestSelector}#{$selector}');
    $newLevel: levels.set-level-emit-target-to-nested($newLevel);
    $void: globals.add-global-bem-level($newLevel);

    /// depth is wrong. (depends on separator)
    /// parent is kind of wrong (depends on separator)
    @include output.emit($newLevel) {
      @content;
    }

    $void: process.end();
  }
}

@mixin compound-entity($args...) {
  @include linked-entities($separator: '', $args...) {
    @content;
  }
}

@mixin descendant-entity($args...) {
  @include linked-entities($separator: ' ', $args...) {
    @content;
  }
}

// to create .hds-myBlock--previousModifier.hds-myBlock--compoundBlock
@mixin compound-block-modifier($modifier, $block: true) {
  $typeAndName: (
    'type': 'modifier',
    'name': $modifier,
  );

  @include compound-entity($typeAndName, $block: $block) {
    @content;
  }
}

@mixin descendant-modifier-element($element, $modifier: true) {
  $typeAndName: (
    'type': 'element',
    'name': $element,
  );

  @include descendant-entity($typeAndName, $modifier: $modifier) {
    @content;
  }
}

@mixin block-element($element, $block: true) {
  $typeAndName: (
    'type': 'element',
    'name': $element,
  );

  @include descendant-entity($typeAndName, $block: $block) {
    @content;
  }
}

// shorthand for custom(' #{$selector}')
// can also be used to add a new child
@mixin descendant($selector) {
  @include custom(' #{$selector}') {
    @content;
  }
}

// shorthand for custom('.#{$selector}')
@mixin class($selector) {
  @include custom('.#{$selector}') {
    @content;
  }
}

// find and repeat closest type:name
@mixin repeat($args...) {
  $closest: levels.find-closest-in-current($args...);

  @if $closest {
    $selector: levels.get-level-selector($closest);
    $createdLevel: process.start(
      $custom: $selector,
    );
    $createdLevel: levels.set-level-emit-target-to-nested($createdLevel);

    @include output.emit($createdLevel) {
      @content;
    }

    $void: process.end();
  }
}

// find closest type:name and repeat with replaced selector
@mixin repeat-with-replace($original, $replacement, $args...) {
  $closest: levels.find-closest-in-current($args...);

  @if $closest {
    $selector: levels.get-level-selector($closest);
    $editedSelector: helpers.replace-string($selector, $original, $replacement);

    @include custom($editedSelector) {
      @content;
    }
  }
}

// returns just a selector
@mixin create-custom-selector($selectorCreator) {
  $ruleMap: globals.get-global-bem-rules();
  $config: globals.get-global-bem-config();
  $currentLevel: process.get-current-level();
  $selector: meta.call($selectorCreator, $ruleMap, $config, $currentLevel);

  @if $selector {
    @include custom($selector) {
      @content;
    }
  }
}

// returns a level
@mixin create-custom-level($levelCreator) {
  $ruleMap: globals.get-global-bem-rules();
  $config: globals.get-global-bem-config();
  $currentLevel: process.get-current-level();
  $newLevel: meta.call($levelCreator, $ruleMap, $config, $currentLevel);
  $selector: levels.get-level-selector($newLevel);

  @if $newLevel and $selector {
    $parentDepth: levels.get-level-depth($currentLevel);
    $newLevel: levels.set-level-parent($newLevel, $currentLevel);
    $newLevel: levels.set-level-depth($newLevel, $parentDepth + 1);
    $void: globals.add-global-bem-level($newLevel);

    @include output.emit($newLevel) {
      @content;
    }

    $void: process.end();

    @include custom($selector) {
      @content;
    }
  }
}

@mixin create-selector($args...) {
  ////
}

@mixin create-list-of-selector($args...) {
  ////
}

/// https://sass-lang.com/documentation/modules/selector/#extend
/// https://developer.mozilla.org/en-US/docs/Web/CSS/CSS_selectors/Selectors_and_combinators#combinators
